<!DOCTYPE html>
<html>
  <head>
    <title>Node Test</title></head>
    <script src='http://code.jquery.com/jquery-latest.min.js' type='text/javascript'></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
<body>
  <canvas id="canvas" width="1000" height="500"></canvas>
  <img src="http://qrickit.com/api/qr?d=http://facebook-hack.nodejitsu.com/controls.html">
  <script>
    var canvas = $("#canvas")[0];
    var ctx = canvas.getContext("2d");
    var w = $("#canvas").width();
    var h = $("#canvas").height();

    var bombs = [];
    var players = {};

    function Player(x, y, color){
      this.x = x;
      this.y = y;
      this.xVel = 0;
      this.yVel = 0;
      this.color = color;
      this.score = 0;
      this.kill = function(){
        this.x = Math.random() * w;
        this.y = Math.random() * h;
        this.score = this.score - 1;
      }
      this.paint = function(ctx){
        ctx.fillStyle = color;
        ctx.fillRect(this.x, this.y, 15, 15);

        if(this.x + this.xVel <= w - 15 && this.x + this.xVel >= 0)
          this.x += this.xVel;
        if(this.y + this.yVel <= h - 15 && this.y + this.yVel >= 0)
          this.y += this.yVel;
      }
    }

    function Bomb(x, y){
      this.x = x;
      this.y = y;
      var _this = this;
      this.radius = 0;
      this.hasExploded = false;
      this.destroyed = false;

      this.paint = function(ctx){
        ctx.fillStyle = "red";

        if(_this.hasExploded){
          ctx.beginPath();
          ctx.arc(x, y, _this.radius, 0, 2 * Math.PI, false);
          ctx.fill();
          if(_this.radius < 70)
            _this.radius += 8;
          else{
            bombs.splice(bombs.indexOf(_this), 1);    // Destroy this bomb
          }

          for(var playerId in players){
            var player = players[playerId];
            if(Math.sqrt(Math.pow(x - player.x, 2) + Math.pow(y - player.y, 2)) < _this.radius){
              player.kill();
            }
          }

          // for(var i=0; i < players.length; i++){
          //   var player = players[i];
            // if(Math.sqrt(Math.pow(x - player.x, 2) + Math.pow(y - player.y, 2)) < _this.radius){
            //   player.kill();
            // }
          // }

        } else {
          ctx.fillRect(this.x, this.y, 10, 10);
        }
      }

      this.explode = function(){
        _this.hasExploded = true;
        console.log("EXPLODE");
      }

      setTimeout(this.explode, 2000);
    }



    function paint(){
      ctx.fillStyle = "white";
      ctx.fillRect(0, 0, w, h);
      ctx.strokeStyle = "black";
      ctx.strokeRect(0, 0, w, h);

      for(var i =0; i < bombs.length; i++)
        bombs[i].paint(ctx);

      // for(i =0; i < players.length; i++)
      //   players[i].paint(ctx);
      for(var playerId in players)
        players[playerId].paint(ctx);
   }

    setInterval(paint, 60);

    var colors = ["blue", "red", "green"];
    var nextColorIndex = 0;

    var socket = io.connect('http://facebook-hack.nodejitsu.com');
    // var socket = io.connect('http://192.17.207.254:8000');

    socket.on('add-player', function(data){
      players[data.id] = new Player(100, 100, colors[nextColorIndex]);
      nextColorIndex = (nextColorIndex + 1) % 3;
    });

    socket.on('a-btn', function (data) {
      if(data.down){
        bombs.push(new Bomb(players[data.id].x, players[data.id].y));
      }
    });

    socket.on('left', function (data) {
      if(data.down)
        players[data.id].xVel = -10;
      else
        players[data.id].xVel = 0;
    });

    socket.on('right', function(data){
      if(data.down)
        players[data.id].xVel = 10;
      else
        players[data.id].xVel = 0;
    });

    socket.on('up', function (data) {
      if(data.down)
        players[data.id].yVel = -10;
      else
        players[data.id].yVel = 0;
    });

    socket.on('down', function (data) {
      if(data.down)
        players[data.id].yVel = 10;
      else
        players[data.id].yVel = 0;
    });

  </script>
</body>
</html>
